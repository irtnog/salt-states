#### CLOUD.PROFILES.D/IRTNOG.CONF --- EC2 instance profiles for the irtnog account

### WARNING: DO NOT EXTEND A PROFILE MORE THAN ONCE!  Extending cloud
### profiles and providers is not recursive.  For example, a profile
### that is extended by a second profile is possible, but the second
### profile cannot be extended by a third profile.
###
### Also, if a profile (or provider) is extending another profile and
### each contains a list of values, the lists from the extending
### profile will override the list from the original profile.  The
### lists are not merged together.

### NOTE: REGARDING AMAZON MACHINE IMAGES FOR WINDOWS, Amazon
### periodically creates new Windows AMIs with the latest Microsoft
### updates installed, deregistering the old ones.  This causes
### salt-cloud deployments using Windows profiles using the
### deregistered AMIs to fail.  When this happens one must update the
### "image" key in affected profiles.  To list the available Windows
### AMIs for a given region, use an AWS CLI command similar to the
### following:
###
### aws ec2 describe-images --owners amazon \
###   --filters "Name=platform,Values=windows" --output table \
###   --query 'Images[*].{ImageId:ImageId,Description:Description}'

{%- if grains['os_family'] == 'FreeBSD' %}
{%- set prefix = '/usr/local' %}
{%- else %}
{%- set prefix = '' %}
{%- endif %}

####
#### PROFILES FOR THE DEFAULT VPC IN US-EAST-1
####

{%- set default_vpc_use1 = salt.irtnog_utils.get_default_vpc_id(
      region='us-east-1') %}
{%- set default_vpc_use1_subnets = [] %}
{%- for subnet in salt.boto_vpc.describe_subnets(
      vpc_id=default_vpc_use1, region='us-east-1')['subnets']
        |sort(attribute='availability_zone') %}
{%-   do default_vpc_use1_subnets.append(subnet['id']) %}
{%- endfor %}
{%- set default_vpc_use1_secgroup = salt.boto_secgroup.get_group_id(
      'default', vpc_id=default_vpc_use1, region='us-east-1') %}
{%- set default_vpc_use1_web_servers = salt.boto_secgroup.get_group_id(
      'web-servers', vpc_id=default_vpc_use1, region='us-east-1') %}

## Amazon Linux 2016.09.1
irtnog-dev-linux:
  provider: irtnog-ec2-nvirginia
  image: ami-0b33d91d
  ssh_username: ec2-user
  size: t2.nano
  block_device_mappings:
    - DeviceName: /dev/xvda
      Ebs.VolumeType: standard  # a/k/a magnetic
  del_root_vol_on_destroy: True
  del_all_vol_on_destroy: True
  network_interfaces:
    - DeviceIndex: 0
      ## auto-assign public IP, not EIP
      AssociatePublicIpAddress: True
      SubnetId:                 # default VPC, us-east-1e
        {{ default_vpc_use1_subnets[4] }}
      SecurityGroupId:
        ## default security group
        - {{ default_vpc_use1_secgroup }}
  tag:
    Environment:
      Development
    Service:
      Software Engineering

dyndns-dev-instance:
  extends: irtnog-dev-linux
  tag:
    dyndns:hostname:
      test.aws.irtnog.org
    dyndns:zoneid:
      {{ salt.boto_route53.describe_hosted_zones(domain_name='aws.irtnog.org.')['HostedZone']['Id'].split('/')[2] }}
    dyndns:rr-ttl:
      '60'

## CentOS Linux 7.4
irtnog-dev-centos:
  provider: irtnog-ec2-nvirginia
  image: ami-46c1b650
  ssh_username: centos
  size: t2.nano
  block_device_mappings:
    - DeviceName: /dev/xvda
      Ebs.VolumeType: standard  # a/k/a magnetic
  del_root_vol_on_destroy: True
  del_all_vol_on_destroy: True
  network_interfaces:
    - DeviceIndex: 0
      ## auto-assign public IP, not EIP
      AssociatePublicIpAddress: True
      SubnetId:                 # default VPC, us-east-1e
        {{ default_vpc_use1_subnets[4] }}
      SecurityGroupId:
        ## default security group
        - {{ default_vpc_use1_secgroup }}
  tag:
    Environment:
      Development
    Service:
      Software Engineering

tech-interview:
  extends: irtnog-dev-centos
  size: t2.small
  network_interfaces:
    - DeviceIndex: 0
      ## auto-assign public IP, not EIP
      AssociatePublicIpAddress: True
      SubnetId:                 # default VPC, us-east-1e
        {{ default_vpc_use1_subnets[4] }}
      SecurityGroupId:
        ## default security group
        - {{ default_vpc_use1_secgroup }}
        ## web servers security group
        # - {{ default_vpc_use1_web_servers }}
  tag:
    dyndns:hostname:
      tech-interview.aws.irtnog.org
    dyndns:zoneid:
      {{ salt.boto_route53.describe_hosted_zones(domain_name='aws.irtnog.org.')['HostedZone']['Id'].split('/')[2] }}
    dyndns:rr-ttl:
      '60'

## Windows Server 2016 Core
irtnog-dev-windows:
  provider: irtnog-ec2-nvirginia
  image: ami-258d8432
  userdata_file: {{ prefix }}/etc/salt/windows-firewall.ps1
  win_installer: /root/Salt-Minion-2016.11.3-AMD64-Setup.exe
  win_username: Administrator
  win_password: auto
{%- if grains.os_family == 'FreeBSD' %}
  use_winrm: True
{%- endif %}
  size: t2.nano
  block_device_mappings:
    - DeviceName: /dev/sda1
      Ebs.VolumeType: standard  # a/k/a magnetic
  del_root_vol_on_destroy: True
  del_all_vol_on_destroy: True
  network_interfaces:
    - DeviceIndex: 0
      AssociatePublicIpAddress: True
      SubnetId:                 # default VPC, us-east-1e
        {{ default_vpc_use1_subnets[4] }}
      SecurityGroupId:
        ## default security group
        - {{ default_vpc_use1_secgroup }}
  tag:
    Environment:
      Development
    Service:
      Software Engineering

#### Local Variables:
#### mode: yaml
#### End:

#### CLOUD.PROFILES.D/IRTNOG.CONF ends here.
