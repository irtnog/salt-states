#### CLOUD.PROFILES.D/IRTNOG.CONF --- EC2 instance profiles for the irtnog account

### WARNING: DO NOT EXTEND A PROFILE MORE THAN ONCE!  Extending cloud
### profiles and providers is not recursive.  For example, a profile
### that is extended by a second profile is possible, but the second
### profile cannot be extended by a third profile.
###
### Also, if a profile (or provider) is extending another profile and
### each contains a list of values, the lists from the extending
### profile will override the list from the original profile.  The
### lists are not merged together.

### NOTE: REGARDING AMAZON MACHINE IMAGE UPDATES, Amazon and Amazon
### Marketplace vendors periodically create new AMIs with the latest
### operating system and software updates pre-installed, deregistering
### the old AMIs.  This causes salt-cloud deployments with profiles
### using the deregistered AMIs to fail.  When this happens one must
### update the "image" key in affected profiles by re-applying the
### `salt.cloud` SLS to the Salt Master.

{%- if grains['os_family'] == 'FreeBSD' %}
{%-   set prefix = '/usr/local' %}
{%- else %}
{%-   set prefix = '' %}
{%- endif %}

{#- Route 53 hosted zone ID for dynamic DNS updates #}
{%- set dyndns_zoneid = salt.boto_route53.describe_hosted_zones(
      domain_name='aws.irtnog.org.',
    )['HostedZone']['Id'].split('/')[2] %}

####
#### DEFAULT PROFILES FOR US-EAST-1
####

{#- Subnets in the us-east-1 default VPC #}
{%- set default_vpc_use1 = salt.irtnog_utils.get_default_vpc_id(
      region='us-east-1') %}
{%- set default_vpc_use1_subnets = [] %}
{%- for subnet in salt.boto_vpc.describe_subnets(
      vpc_id=default_vpc_use1, region='us-east-1')['subnets']
        |sort(attribute='availability_zone') %}
{%-   do default_vpc_use1_subnets.append(subnet['id']) %}
{%- endfor %}

{#- Security groups in the us-east-1 default VPC #}
{%- set default_vpc_use1_secgroup = salt.boto_secgroup.get_group_id(
      'default', vpc_id=default_vpc_use1, region='us-east-1') %}
{%- set default_vpc_use1_web_servers = salt.boto_secgroup.get_group_id(
      'web-servers', vpc_id=default_vpc_use1, region='us-east-1') %}

## Amazon Linux 2017.09.0
{%- set amznlnx_use1 = salt.irtnog_ec2.find_images(filters={
      'name':
        'amzn-ami-hvm-2017.09.0.20170930-x86_64-gp2',
    }, region='us-east-1')[0] %}
irtnog-dev-linux:
  provider: irtnog-ec2-nvirginia
  image: {{ amznlnx_use1 }}
  ssh_username: ec2-user
  size: t2.nano
  block_device_mappings:
    - DeviceName: /dev/xvda
      Ebs.VolumeType: standard  # a/k/a magnetic
  del_root_vol_on_destroy: True
  del_all_vol_on_destroy: True
  network_interfaces:
    - DeviceIndex: 0
      ## auto-assign public IP, not EIP
      AssociatePublicIpAddress: True
      SubnetId:                 # default VPC, us-east-1e
        {{ default_vpc_use1_subnets[4] }}
      SecurityGroupId:
        ## default security group
        - {{ default_vpc_use1_secgroup }}
  tag:
    Environment:
      Development
    Service:
      Software Engineering

## CentOS Linux 7.4 (https://wiki.centos.org/Cloud/AWS)
{%- set centos7_use1 = salt.irtnog_ec2.find_images(filters={
      'product_code':
        'aw0evgkw8e5c1q413zgy5pjce',
    }, region='us-east-1')[0] %}
irtnog-dev-centos:
  provider: irtnog-ec2-nvirginia
  image: {{ centos7_use1 }}
  ssh_username: centos
  size: t2.nano
  block_device_mappings:
    - DeviceName: /dev/xvda
      Ebs.VolumeType: standard  # a/k/a magnetic
  del_root_vol_on_destroy: True
  del_all_vol_on_destroy: True
  network_interfaces:
    - DeviceIndex: 0
      ## auto-assign public IP, not EIP
      AssociatePublicIpAddress: True
      SubnetId:                 # default VPC, us-east-1e
        {{ default_vpc_use1_subnets[4] }}
      SecurityGroupId:
        ## default security group
        - {{ default_vpc_use1_secgroup }}
  tag:
    Environment:
      Development
    Service:
      Software Engineering

## Windows Server 2016 Core
{%- set win2016_core_use1 = salt.irtnog_ec2.find_images(filters={
      'description':
        'Microsoft Windows Server 2016 Core Locale English AMI provided by Amazon',
    }, region='us-east-1')[0] %}
irtnog-dev-windows:
  provider: irtnog-ec2-nvirginia
  image: {{ win2016_core_use1 }}
  userdata_file: {{ prefix }}/etc/salt/windows-firewall.ps1
  win_installer: /root/Salt-Minion-2016.11.3-AMD64-Setup.exe
  win_username: Administrator
  win_password: auto
{%- if grains.os_family == 'FreeBSD' %}
  use_winrm: True
{%- endif %}
  size: t2.nano
  block_device_mappings:
    - DeviceName: /dev/sda1
      Ebs.VolumeType: standard  # a/k/a magnetic
  del_root_vol_on_destroy: True
  del_all_vol_on_destroy: True
  network_interfaces:
    - DeviceIndex: 0
      AssociatePublicIpAddress: True
      SubnetId:                 # default VPC, us-east-1e
        {{ default_vpc_use1_subnets[4] }}
      SecurityGroupId:
        ## default security group
        - {{ default_vpc_use1_secgroup }}
  tag:
    Environment:
      Development
    Service:
      Software Engineering

####
#### DEVELOPMENT INSTANCES IN THE DEFAULT VPC OF US-EAST-1
####

dyndns-dev-instance:
  extends: irtnog-dev-linux
  tag:
    dyndns:hostname:
      test.aws.irtnog.org
    dyndns:zoneid:
      {{ dyndns_zoneid }}
    dyndns:rr-ttl:
      '60'

tech-interview:
  extends: irtnog-dev-centos
  size: t2.small
  network_interfaces:
    - DeviceIndex: 0
      ## auto-assign public IP, not EIP
      AssociatePublicIpAddress: True
      SubnetId:                 # default VPC, us-east-1e
        {{ default_vpc_use1_subnets[4] }}
      SecurityGroupId:
        ## default security group
        - {{ default_vpc_use1_secgroup }}
        ## web servers security group
        # - {{ default_vpc_use1_web_servers }}
  tag:
    dyndns:hostname:
      tech-interview.aws.irtnog.org
    dyndns:zoneid:
      {{ dyndns_zoneid }}
    dyndns:rr-ttl:
      '60'

#### Local Variables:
#### mode: yaml
#### End:

#### CLOUD.PROFILES.D/IRTNOG.CONF ends here.
